"""
Vulnerability Detection Logging Module

Provides comprehensive logging for vulnerability detection and classification.
Tracks intermediate results at each stage of vulnerability analysis.
"""

import logging
from typing import List, Dict, Any
from enum import Enum
from dataclasses import dataclass
from datetime import datetime

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)

logger = logging.getLogger(__name__)


class CheckStatus(Enum):
    """Status of a vulnerability check."""
    PASSED = "PASSED"
    FAILED = "FAILED"
    WARNING = "WARNING"


@dataclass
class VulnerabilityCheckLog:
    """Log entry for a single vulnerability check."""
    check_name: str
    status: CheckStatus
    details: str
    severity: float = 0.0
    patterns_found: List[str] = None
    
    def __post_init__(self):
        if self.patterns_found is None:
            self.patterns_found = []
    
    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary."""
        return {
            "check": self.check_name,
            "status": self.status.value,
            "details": self.details,
            "severity": self.severity,
            "patterns": self.patterns_found
        }


class VulnerabilityLogger:
    """Comprehensive logger for vulnerability detection."""
    
    def __init__(self, url: str, payload: str = None):
        self.url = url
        self.payload = payload
        self.start_time = datetime.now()
        self.checks: List[VulnerabilityCheckLog] = []
        self.overall_status = CheckStatus.PASSED
        self.overall_verdict = "SAFE"
    
    def log_check(self, check_name: str, passed: bool, details: str, 
                  severity: float = 0.0, patterns: List[str] = None):
        """Log a single check result."""
        status = CheckStatus.PASSED if passed else CheckStatus.FAILED
        if not passed:
            self.overall_status = CheckStatus.FAILED
            self.overall_verdict = "UNSAFE"
        
        check_log = VulnerabilityCheckLog(
            check_name=check_name,
            status=status,
            details=details,
            severity=severity,
            patterns_found=patterns or []
        )
        self.checks.append(check_log)
        
        # Log to file
        status_str = "✓" if passed else "✗"
        logger.info(f"{status_str} {check_name}: {details}")
        if patterns:
            logger.info(f"  Patterns detected: {', '.join(patterns)}")
    
    def log_sql_injection_check(self, patterns_found: List[str]):
        """Log SQL injection check."""
        passed = len(patterns_found) == 0
        details = f"SQL injection: {len(patterns_found)} pattern(s) detected" if patterns_found else "No SQL injection patterns detected"
        self.log_check("SQL Injection", passed, details, severity=0.95, patterns=patterns_found)
    
    def log_xss_check(self, patterns_found: List[str]):
        """Log XSS check."""
        passed = len(patterns_found) == 0
        details = f"XSS: {len(patterns_found)} pattern(s) detected" if patterns_found else "No XSS patterns detected"
        self.log_check("XSS (Cross-Site Scripting)", passed, details, severity=0.85, patterns=patterns_found)
    
    def log_path_traversal_check(self, patterns_found: List[str]):
        """Log path traversal check."""
        passed = len(patterns_found) == 0
        details = f"Path Traversal: {len(patterns_found)} pattern(s) detected" if patterns_found else "No path traversal patterns detected"
        self.log_check("Path Traversal", passed, details, severity=0.80, patterns=patterns_found)
    
    def log_command_injection_check(self, patterns_found: List[str]):
        """Log command injection check."""
        passed = len(patterns_found) == 0
        details = f"Command Injection: {len(patterns_found)} pattern(s) detected" if patterns_found else "No command injection patterns detected"
        self.log_check("Command Injection", passed, details, severity=0.90, patterns=patterns_found)
    
    def log_security_headers_check(self, has_issues: bool, issues: List[str]):
        """Log security headers check."""
        details = f"Security Headers: {len(issues)} issue(s)" if issues else "Security headers validation passed"
        self.log_check("Security Headers", not has_issues, details, severity=0.60, patterns=issues)
    
    def log_https_check(self, uses_https: bool):
        """Log HTTPS check."""
        details = "HTTPS: Secure connection enabled" if uses_https else "HTTPS: Uses insecure HTTP"
        self.log_check("HTTPS/Encryption", uses_https, details, severity=0.70)
    
    def log_open_directory_check(self, has_issues: bool, issues: List[str]):
        """Log open directory check."""
        details = f"Open Directories: {len(issues)} exposed endpoint(s)" if issues else "No exposed directories detected"
        self.log_check("Open Directories", not has_issues, details, severity=0.50, patterns=issues)
    
    def log_ml_prediction(self, label: str, probability: float, anomaly_score: float):
        """Log ML model prediction."""
        details = f"ML Model - Label: {label}, Probability: {probability:.1%}, Anomaly: {anomaly_score:.3f}"
        passed = label == "safe" and anomaly_score < 0.3
        self.log_check("ML Model Prediction", passed, details)
    
    def get_report(self) -> Dict[str, Any]:
        """Get comprehensive vulnerability report."""
        elapsed = (datetime.now() - self.start_time).total_seconds()
        
        passed_checks = sum(1 for check in self.checks if check.status == CheckStatus.PASSED)
        failed_checks = sum(1 for check in self.checks if check.status == CheckStatus.FAILED)
        
        return {
            "timestamp": self.start_time.isoformat(),
            "url": self.url,
            "payload": self.payload,
            "verdict": self.overall_verdict,
            "overall_status": self.overall_status.value,
            "checks_passed": passed_checks,
            "checks_failed": failed_checks,
            "total_checks": len(self.checks),
            "elapsed_seconds": elapsed,
            "detailed_checks": [check.to_dict() for check in self.checks],
        }
    
    def print_report(self):
        """Print formatted vulnerability report."""
        report = self.get_report()
        
        print("\n" + "="*80)
        print("VULNERABILITY DETECTION REPORT")
        print("="*80)
        print(f"Timestamp: {report['timestamp']}")
        print(f"URL: {report['url']}")
        if report['payload']:
            print(f"Payload: {report['payload']}")
        print(f"\nVerdict: {'✓ SAFE' if report['verdict'] == 'SAFE' else '✗ UNSAFE'}")
        print(f"Overall Status: {report['overall_status']}")
        print(f"Checks Passed: {report['checks_passed']}/{report['total_checks']}")
        print(f"Elapsed Time: {report['elapsed_seconds']:.3f}s")
        print("\n" + "-"*80)
        print("DETAILED VULNERABILITY CHECKS:")
        print("-"*80)
        
        for i, check in enumerate(report['detailed_checks'], 1):
            status_icon = "✓" if check['status'] == "PASSED" else "✗"
            print(f"\n{i}. {status_icon} {check['check']}")
            print(f"   Status: {check['status']}")
            print(f"   Details: {check['details']}")
            if check['severity'] > 0:
                print(f"   Severity: {check['severity']:.2f}")
            if check['patterns']:
                print(f"   Patterns: {', '.join(check['patterns'])}")
        
        print("\n" + "="*80)


def format_vulnerability_response(logger: VulnerabilityLogger, is_safe: bool) -> Dict[str, Any]:
    """Format vulnerability detection response."""
    report = logger.get_report()
    
    # List all detected vulnerabilities
    vulnerabilities = []
    for check in report['detailed_checks']:
        if check['status'] == 'FAILED':
            vulnerabilities.append({
                "type": check['check'],
                "severity": check['severity'],
                "patterns": check['patterns'],
                "details": check['details']
            })
    
    return {
        "is_safe": is_safe,
        "verdict": report['verdict'],
        "total_vulnerabilities_detected": len(vulnerabilities),
        "vulnerabilities": vulnerabilities,
        "checks_summary": {
            "passed": report['checks_passed'],
            "failed": report['checks_failed'],
            "total": report['total_checks']
        },
        "full_report": report
    }
