

import React, { useState } from 'react';
import jsPDF from 'jspdf';
import { AlertTriangle, CheckCircle, Zap, Copy, Shield, Code, Download, Brain, Eye, EyeOff } from 'lucide-react';
import '../styles/VulnerabilityAnalysis.css';

interface AnalysisResult {
  isVulnerable: boolean;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'safe';
  vulnerabilityType: string;
  explanation: string;
  remediations: string[];
  codeSnippets: CodeSnippet[];
  cweId: string;
  owasp: string;
  anomalyScore: number;
  timestamp: string;
  mlModel: 'isolationForest' | 'lightgbm';
  potentialAttacks?: string[];
  securityHeaders?: {[key: string]: string | boolean};
}

interface CodeSnippet {
  language: string;
  title: string;
  vulnerable: string;
  secure: string;
}

type AnalysisMode = 'payload' | 'website' | 'codeSnippet';

export function VulnerabilityAnalysis() {
  // State hooks

  // Handle analysis button click
  const handleAnalysis = async () => {
    setError('');
    setIsAnalyzing(true);
    try {
      let analysisResult: AnalysisResult | null = null;
      if (analysisMode === 'payload') {
        if (!url.trim()) {
          setError('Please enter a target URL');
          setIsAnalyzing(false);
          return;
        }
        if (!payload.trim()) {
          analysisResult = await assessWebsiteSecurity(url);
        } else {
          analysisResult = await analyzePayload(payload, url);
        }
      } else if (analysisMode === 'website') {
        if (!url.trim()) {
          setError('Please enter a website URL');
          setIsAnalyzing(false);
          return;
        }
        analysisResult = await assessWebsiteSecurity(url);
      } else if (analysisMode === 'codeSnippet') {
        if (!codeSnippet.trim()) {
          setError('Please enter code to analyze');
          setIsAnalyzing(false);
          return;
        }
        analysisResult = await analyzeCodeSnippet(codeSnippet, codeLanguage);
      }
      setResult(analysisResult);
      setActiveTab('overview');
    } catch (err: any) {
      setError(err.message || 'Analysis failed');
    } finally {
      setIsAnalyzing(false);
    }
  };
  const [analysisMode, setAnalysisMode] = useState<AnalysisMode>('payload');
  const [url, setUrl] = useState('');
  const [payload, setPayload] = useState('');
  const [codeSnippet, setCodeSnippet] = useState('');
  const [codeLanguage, setCodeLanguage] = useState('python');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [result, setResult] = useState<AnalysisResult | null>(null);
  const [error, setError] = useState('');
  const [copiedIndex, setCopiedIndex] = useState<number | null>(null);
  const [activeTab, setActiveTab] = useState<'overview' | 'code' | 'remediation'>('overview');

  // ML Model selection
  const selectMLModel = (): 'isolationForest' | 'lightgbm' => {
    return Math.random() > 0.5 ? 'isolationForest' : 'lightgbm';
  };

  // Calculate anomaly score
  const calculateAnomalyScore = (input: string, model: 'isolationForest' | 'lightgbm'): number => {
    const inputLength = input.length;
    const specialCharsCount = (input.match(/[<>'";()&|`$\[\]{}]/g) || []).length;
    const sqlKeywords = (input.match(/union|select|insert|update|delete|drop|exec|union all|or\s+1|where|from/gi) || []).length;
    const xssPatterns = (input.match(/<script|javascript:|onerror|onload|alert|eval/gi) || []).length;
    const pathTraversalPatterns = (input.match(/\.\.\//g) || []).length;

    const isolationForestScore = Math.min(100, 
      (specialCharsCount * 8) +
      (sqlKeywords * 15) +
      (xssPatterns * 20) +
      (pathTraversalPatterns * 25) +
      Math.abs(inputLength - 10) / 5
    );

    const lightgbmScore = Math.min(100,
      (specialCharsCount * 10) +
      (sqlKeywords * 18) +
      (xssPatterns * 22) +
      (pathTraversalPatterns * 20) +
      (inputLength > 50 ? 15 : 0)
    );

    return model === 'isolationForest' ? isolationForestScore : lightgbmScore;
  };

  // Website security assessment
  const assessWebsiteSecurity = async (websiteUrl: string): Promise<AnalysisResult> => {
    const mlModel = selectMLModel();

    // Simulate checking security headers and SSL
    const securityHeaders = {
      'Content-Security-Policy': true,
      'X-Frame-Options': true,
      'X-Content-Type-Options': true,
      'Strict-Transport-Security': true,
      'X-XSS-Protection': false,
      'Referrer-Policy': true,
    };

    // Simulate security assessment
    const missingHeaders = Object.entries(securityHeaders)
      .filter(([_, present]) => !present)
      .map(([header]) => header);

    const hasHttps = websiteUrl.startsWith('https://');
    const isVulnToAttacks = !hasHttps || missingHeaders.length > 2;

    // derive a rule-based anomaly score so misconfigurations influence ML risk
    let baseScore = missingHeaders.length * 15 + (hasHttps ? 0 : 35);
    // small boost for any missing header to ensure non-zero score when vulnerable
    if (missingHeaders.length > 0) baseScore += 5;
    const computedAnomaly = Math.min(100, Math.round(baseScore * 10) / 10);

    // ensure vulnerability flags always map to at least LOW risk (>=10)
    const finalAnomaly = isVulnToAttacks && computedAnomaly < 10 ? 10 : computedAnomaly;

    // Severity must align with vulnerability status
    const severity: 'critical' | 'high' | 'medium' | 'low' | 'safe' = isVulnToAttacks 
      ? (missingHeaders.length > 3 || !hasHttps ? 'high' : 'medium')
      : 'safe';

    const result: AnalysisResult = {
      isVulnerable: isVulnToAttacks,
      severity: severity,
      vulnerabilityType: isVulnToAttacks ? 'Security Misconfiguration' : 'Well-Configured Website',
      explanation: isVulnToAttacks 
        ? `This website has ${missingHeaders.length} missing security headers and ${hasHttps ? '' : 'no'} HTTPS protection. These misconfigurations could expose the application to common attacks.`
        : 'This website demonstrates good security practices with proper headers and HTTPS enabled.',
      remediations: isVulnToAttacks ? [
        `Implement missing security headers: ${missingHeaders.join(', ')}`,
        'Enable HTTPS/TLS for all communications',
        'Set secure cookie flags (HttpOnly, Secure, SameSite)',
        'Configure CORS policy properly',
        'Enable HTTP Strict-Transport-Security (HSTS)',
        'Implement Content Security Policy (CSP)',
        'Regular security scanning and updates',
      ] : [
        'Continue maintaining security headers',
        'Perform regular security audits',
        'Keep dependencies updated',
        'Monitor for known vulnerabilities',
      ],
      codeSnippets: [
        {
          language: 'javascript',
          title: 'Express.js Security Headers Setup',
          vulnerable: `// VULNERABLE: No security headers
const express = require('express');
const app = express();
app.listen(3000);`,
          secure: `// SAFE: With security headers
const express = require('express');
const helmet = require('helmet');
const app = express();

// Use helmet to set security headers
app.use(helmet());

// Additional custom headers
app.use((req, res, next) => {
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  next();
});

app.listen(3000);`
        },
        {
          language: 'python',
          title: 'Flask Security Headers Setup',
          vulnerable: `# VULNERABLE: No security headers
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello():
    return 'Hello World'`,
          secure: `# SAFE: With security headers
from flask import Flask
from flask_talisman import Talisman

app = Flask(__name__)
Talisman(app, force_https=True)

@app.route('/')
def hello():
    return 'Hello World'`
        }
      ],
      cweId: 'CWE-693',
      owasp: 'A05:2021 – Misconfigurations',
      anomalyScore: finalAnomaly,
      timestamp: new Date().toISOString(),
      mlModel,
      potentialAttacks: isVulnToAttacks ? [
        'Man-in-the-Middle (MITM) Attacks',
        'Cross-Site Scripting (XSS)',
        'Clickjacking',
        'CSRF Attacks',
        'Information Disclosure'
      ] : [],
      securityHeaders
    };

    return result;
  };

  // Code snippet vulnerability analysis
  const analyzeCodeSnippet = async (code: string, language: string): Promise<AnalysisResult> => {
    const mlModel = selectMLModel();

    // Detect vulnerabilities in code
    const vulnerabilities = {
      sqlInjection: /execute|query|select|insert|delete|update|drop|\$\{|f['"]|`/i.test(code) && /'[\w\s]*['"]|f['"][\w\s]*['"]/.test(code),
      xss: /innerHTML|dangerouslySetInnerHTML|eval|script/.test(code),
      pathTraversal: /\.\.\//i.test(code),
      hardcodedSecrets: /password|api[_-]?key|secret|token/.test(code) && /[=:]\s*['"][^'"]*['"]/.test(code),
    };

    const foundVulns = Object.entries(vulnerabilities).filter(([_, found]) => found).map(([name]) => name);

    const result: AnalysisResult = {
      isVulnerable: foundVulns.length > 0,
      severity: foundVulns.length > 2 ? 'critical' : foundVulns.length > 0 ? 'high' : 'safe',
      vulnerabilityType: foundVulns.length > 0 ? `${foundVulns.length} Vulnerability/Vulnerabilities Detected` : 'Secure Code',
      explanation: foundVulns.length > 0
        ? `Found potential ${foundVulns.join(', ')} vulnerabilities in the code. Review the highlighted patterns and apply recommended fixes.`
        : 'The code snippet appears to follow security best practices.',
      remediations: foundVulns.length > 0 ? [
        ...(vulnerabilities.sqlInjection ? [
          '❌ SQL Injection: Replace string concatenation with parameterized queries',
          'Example: Use cursor.execute("SELECT * FROM users WHERE id=?", (user_id,)) instead of f-strings',
          'Use ORM frameworks (SQLAlchemy, Sequelize) that auto-escape inputs'
        ] : []),
        ...(vulnerabilities.xss ? [
          '❌ XSS Vulnerability: Never use innerHTML with user input',
          'Example: Replace element.innerHTML = userInput with element.textContent = userInput',
          'Implement Content-Security-Policy headers to prevent inline scripts'
        ] : []),
        ...(vulnerabilities.pathTraversal ? [
          '❌ Path Traversal: Validate file paths to prevent directory escape',
          'Example: Use Path(base_dir / user_input).resolve() and verify it stays within base_dir',
          'Maintain whitelist of allowed directories, run with minimal permissions'
        ] : []),
        ...(vulnerabilities.hardcodedSecrets ? [
          '❌ Hardcoded Secret: Move credentials to environment variables',
          'Example: Use os.getenv("API_KEY") instead of hardcoding in source',
          'Use .env files (never committed) and implement secret rotation'
        ] : [])
      ] : [
        '✅ Continue following security best practices',
        '✅ Keep using parameterized queries',
        '✅ Maintain secure coding standards',
      ],
      codeSnippets: [
        {
          language: language,
          title: `${language.charAt(0).toUpperCase() + language.slice(1)} - Secure Implementation`,
          vulnerable: code.substring(0, Math.min(300, code.length)) + (code.length > 300 ? '\n// ...' : ''),
          secure: language === 'python' ? (
            vulnerabilities.sqlInjection ? 'import sqlite3\ncursor = sqlite3.cursor()\n# SAFE:\ncursor.execute("SELECT * FROM users WHERE id=?", (user_id,))\n\n# With ORM (SQLAlchemy):\nuser = session.query(User).filter(User.id == user_id).first()' :
            vulnerabilities.xss ? 'from flask import Flask, escape\n\n@app.route("/display")\ndef display(user_input):\n    safe = escape(user_input)\n    return f\'<p>{safe}</p>\'\n\n# React equivalent:\n# In JSX, React auto-escapes: <p>{userInput}</p>' :
            vulnerabilities.pathTraversal ? 'from pathlib import Path\n\nBASE_DIR = Path("/uploads").resolve()\nreq_path = (BASE_DIR / user_input).resolve()\nif not str(req_path).startswith(str(BASE_DIR)):\n    raise ValueError("Path traversal detected")\nwith open(req_path) as f:\n    content = f.read()' :
            vulnerabilities.hardcodedSecrets ? 'import os\nfrom dotenv import load_dotenv\n\nload_dotenv()\nAPI_KEY = os.getenv("API_KEY")\nif not API_KEY:\n    raise ValueError("API_KEY env var required")\n\n# .env file contains: API_KEY=your_actual_key' :
            '# Code is secure - continue using these patterns'
          ) : language === 'javascript' ? (
            vulnerabilities.sqlInjection ? 'const mysql = require("mysql2/promise");\n\n// Using prepared statements:\nconst [rows] = await connection.execute(\n  "SELECT * FROM users WHERE id = ?",\n  [userId]\n);\n\n// Or with Sequelize ORM:\nconst user = await User.findByPk(userId);' :
            vulnerabilities.xss ? '// SAFE: Use textContent\nelem.textContent = userInput;\n\n// Add CSP Header:\napp.use((req, res, next) => {\n  res.setHeader(\n    "Content-Security-Policy",\n    "script-src \'self\'"\n  );\n  next();\n});' :
            vulnerabilities.pathTraversal ? 'const path = require("path");\nconst BASE_DIR = path.resolve("/uploads");\n\nconst requested = path.resolve(BASE_DIR, userPath);\nif (!requested.startsWith(BASE_DIR)) {\n  throw new Error("Path traversal attempt");\n}\nconst content = fs.readFileSync(requested);' :
            vulnerabilities.hardcodedSecrets ? 'require("dotenv").config();\n\nconst API_KEY = process.env.API_KEY;\nif (!API_KEY) {\n  throw new Error("API_KEY env var required");\n}\n\n// .env file: API_KEY=your_actual_key' :
            '// Code is secure - continue using these patterns'
          ) : 'Review the code and apply recommended security fixes'
        }
      ],
      cweId: 'Multiple',
      owasp: 'A03:2021 – Injection',
      anomalyScore: foundVulns.length * 20,
      timestamp: new Date().toISOString(),
      mlModel,
    };

    return result;
  };

  // Payload analysis
  const analyzePayload = async (payloadText: string, websiteUrl: string): Promise<AnalysisResult> => {
    const mlModel = selectMLModel();
    // Patterns for quick detection
    const vulnerabilityPatterns: { [key: string]: Omit<AnalysisResult, 'timestamp' | 'anomalyScore' | 'mlModel'> } = {
      'OR 1=1': {
        isVulnerable: true,
        severity: 'critical',
        vulnerabilityType: 'SQL Injection',
        explanation: 'SQL Injection attack detected. This payload bypasses authentication by making WHERE clause conditions always true.',
        remediations: [
          'Use parameterized queries or prepared statements',
          'Implement input validation and sanitization',
          'Apply principle of least privilege to DB accounts',
          'Use ORM frameworks with automatic escaping',
          'Implement Web Application Firewall (WAF) rules',
        ],
        codeSnippets: [
          {
            language: 'python',
            title: 'SQL Injection Prevention',
            vulnerable: "query = f\"SELECT * FROM users WHERE username='{username}' AND password='{password}'\"",
            secure: "query = \"SELECT * FROM users WHERE username=? AND password=?\"\ncursor.execute(query, (username, password))"
          }
        ],
        cweId: 'CWE-89',
        owasp: 'A03:2021 – Injection',
      },
      '<script>': {
        isVulnerable: true,
        severity: 'critical',
        vulnerabilityType: 'Cross-Site Scripting (XSS)',
        explanation: 'XSS vulnerability detected. Malicious scripts can be injected into the application.',
        remediations: [
          'Use textContent instead of innerHTML',
        ],
        codeSnippets: [
          {
            language: 'javascript',
            title: 'XSS Prevention',
            vulnerable: "element.innerHTML = userInput;",
            secure: "element.textContent = userInput;"
          }
        ],
        cweId: 'CWE-79',
        owasp: 'A03:2021 – Injection',
      },
      '../': {
        isVulnerable: true,
        severity: 'high',
        vulnerabilityType: 'Path Traversal',
        explanation: 'Path traversal attack detected. This could allow access to files outside intended directory.',
        remediations: [
          'Use path canonicalization',
          'Validate against whitelist of allowed paths',
          'Use secure file handling APIs',
          'Run with minimal file system permissions',
        ],
        codeSnippets: [
          {
            language: 'python',
            title: 'Path Traversal Prevention',
            vulnerable: "file_path = \"/uploads/\" + user_input\nwith open(file_path) as f:\n    return f.read()",
            secure: "from pathlib import Path\nbase_path = Path(\"/uploads\").resolve()\nrequested_path = (base_path / user_input).resolve()\nif not str(requested_path).startswith(str(base_path)):\n    raise ValueError(\"Invalid path\")\nwith open(requested_path) as f:\n    return f.read()"
          }
        ],
        cweId: 'CWE-22',
        owasp: 'A01:2021 – Broken Access Control',
      },
    };

    // Check for known patterns
    for (const pattern in vulnerabilityPatterns) {
      if (payloadText.includes(pattern)) {
        const base = vulnerabilityPatterns[pattern];
        return {
          ...base,
          anomalyScore: 90,
          timestamp: new Date().toISOString(),
          mlModel,
        };
      }
    }

    // Fallback: ML-based scoring
    const anomalyScore = calculateAnomalyScore(payloadText, mlModel);
    const isVulnerable = anomalyScore > 25;
    return {
      isVulnerable,
      severity: isVulnerable ? (anomalyScore > 75 ? 'critical' : anomalyScore > 50 ? 'high' : 'medium') : 'safe',
      vulnerabilityType: isVulnerable ? 'Potential Injection/Attack Pattern' : 'No Known Vulnerability',
      explanation: isVulnerable
        ? 'The payload contains suspicious patterns or characteristics that may indicate a vulnerability. Review and sanitize all user inputs.'
        : 'No known vulnerability patterns detected in the payload.',
      remediations: isVulnerable
        ? [
            'Sanitize and validate all user inputs',
            'Use parameterized queries and prepared statements',
            'Implement Content Security Policy (CSP)',
            'Avoid dangerous functions (eval, exec, etc.)',
          ]
        : ['No remediation needed.'],
      codeSnippets: [],
      cweId: isVulnerable ? 'CWE-20' : 'N/A',
      owasp: isVulnerable ? 'A03:2021 – Injection' : 'N/A',
      anomalyScore,
      timestamp: new Date().toISOString(),
      mlModel,
    };
  };

  // PDF Download function (jsPDF)
  // PDF Download function (jsPDF)
  const downloadPDFReport = async () => {
    if (!result) return;
    const pdf = new jsPDF();
    const margin = 20;
    let y = margin;

    pdf.setFontSize(18);
    pdf.text('Security Analysis Report', margin, y);
    y += 10;

    pdf.setFontSize(12);
    pdf.text(`Analysis Date: ${new Date(result.timestamp).toLocaleString()}`, margin, y);
    y += 8;
    pdf.text(`Target: ${url || 'Code Snippet'}`, margin, y);
    y += 8;

    pdf.setFontSize(14);
    pdf.text('Vulnerability Details', margin, y);
    y += 8;
    pdf.setFontSize(11);
    pdf.text(`Type: ${result.vulnerabilityType}`, margin, y);
    y += 7;
    pdf.text(`Status: ${result.isVulnerable ? 'VULNERABLE' : 'SAFE'}`, margin, y);
    y += 7;
    pdf.text(`Severity: ${result.severity.toUpperCase()}`, margin, y);
    y += 7;

    pdf.setFontSize(13);
    pdf.text('Explanation', margin, y);
    y += 7;
    pdf.setFontSize(10);
    const explanationLines = pdf.splitTextToSize(result.explanation, 170);
    pdf.text(explanationLines, margin, y);
    y += explanationLines.length * 5 + 2;

    pdf.setFontSize(13);
    pdf.text('ML Analysis', margin, y);
    y += 7;
    pdf.setFontSize(10);
    pdf.text(`Model: ${result.mlModel === 'isolationForest' ? 'Isolation Forest' : 'LightGBM'}`, margin, y);
    y += 6;
    pdf.text(`Anomaly Score: ${result.anomalyScore}/100`, margin, y);
    y += 8;

    pdf.setFontSize(13);
    pdf.text('Remediation Steps', margin, y);
    y += 7;
    pdf.setFontSize(10);
    if (result.remediations && result.remediations.length > 0) {
      result.remediations.forEach((step: string, idx: number) => {
        pdf.text(`${idx + 1}. ${step}`, margin + 4, y);
        y += 6;
      });
    } else {
      pdf.text('No remediation steps provided.', margin + 4, y);
      y += 6;
    }

    y += 2;
    pdf.setFontSize(13);
    pdf.text('CWE & OWASP', margin, y);
    y += 7;
    pdf.setFontSize(10);
    pdf.text(`CWE ID: ${result.cweId}`, margin, y);
    y += 6;
    pdf.text(`OWASP: ${result.owasp}`, margin, y);
    y += 8;

    // Save the PDF
    pdf.save(`security-report-${Date.now()}.pdf`);
  };

  const getSeverityColor = (severity: string): string => {
    switch (severity) {
      case 'critical': return '#d946ef';
      case 'high': return '#ef4444';
      case 'medium': return '#f97316';
      case 'low': return '#eab308';
      case 'safe': return '#22c55e';
      default: return '#6b7280';
    }
  };

  const copyToClipboard = (text: string, index: number) => {
    navigator.clipboard.writeText(text);
    setCopiedIndex(index);
    setTimeout(() => setCopiedIndex(null), 2000);
  };

  const getRiskLevel = (anomalyScore: number): string => {
    if (anomalyScore >= 75) return 'CRITICAL';
    if (anomalyScore >= 50) return 'HIGH';
    if (anomalyScore >= 25) return 'MEDIUM';
    if (anomalyScore >= 10) return 'LOW';
    return 'MINIMAL';
  };

  return (
    <div className="vulnerability-analysis">
      <div className="analysis-header">
        <h1>Vulnerability Analysis Suite</h1>
        <p>Analyze payloads, websites, and code for security vulnerabilities</p>
      </div>

      <div className="analysis-container">
        {/* Mode Selector */}
        <div className="card card--glass analysis-card">
          <div className="mode-selector">
            <button
              className={`mode-btn ${analysisMode === 'payload' ? 'active' : ''}`}
              onClick={() => setAnalysisMode('payload')}
            >
              <Code size={18} />
              Payload Analysis
            </button>
            <button
              className={`mode-btn ${analysisMode === 'website' ? 'active' : ''}`}
              onClick={() => setAnalysisMode('website')}
            >
              <Shield size={18} />
              Website Security
            </button>
            <button
              className={`mode-btn ${analysisMode === 'codeSnippet' ? 'active' : ''}`}
              onClick={() => setAnalysisMode('codeSnippet')}
            >
              <AlertTriangle size={18} />
              Code Analysis
            </button>
          </div>
        </div>

        {/* Payload Analysis Form */}
        {analysisMode === 'payload' && (
          <div className="card card--glass analysis-card">
            <div className="analysis-form">
              <div className="form-group">
                <label htmlFor="url" className="input-label">
                  Target URL <span className="required">*</span>
                </label>
                <input
                  id="url"
                  type="text"
                  className="input"
                  placeholder="https://example.com/search?q="
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  disabled={isAnalyzing}
                />
              </div>

              <div className="form-group">
                <label htmlFor="payload" className="input-label">
                  Payload <span className="optional">(Optional)</span>
                </label>
                <p className="input-hint">Leave empty to analyze website security, or enter a payload to analyze</p>
                <textarea
                  id="payload"
                  className="input"
                  placeholder="e.g., OR 1=1, <script>alert('xss')</script>, ../../../etc/passwd"
                  value={payload}
                  onChange={(e) => setPayload(e.target.value)}
                  disabled={isAnalyzing}
                  rows={4}
                />
              </div>

              {error && (
                <div className="alert alert--error">
                  <AlertTriangle size={16} />
                  {error}
                </div>
              )}

              <button className="btn btn--primary" onClick={handleAnalysis} disabled={isAnalyzing || !url.trim()}>
                <Zap size={16} />
                {isAnalyzing ? 'Analyzing...' : 'Analyze'}
              </button>
            </div>
          </div>
        )}

        {/* Website Security Form */}
        {analysisMode === 'website' && (
          <div className="card card--glass analysis-card">
            <div className="analysis-form">
              <div className="form-group">
                <label htmlFor="website-url" className="input-label">
                  Website URL <span className="required">*</span>
                </label>
                <input
                  id="website-url"
                  type="text"
                  className="input"
                  placeholder="https://example.com"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  disabled={isAnalyzing}
                />
              </div>

              {error && (
                <div className="alert alert--error">
                  <AlertTriangle size={16} />
                  {error}
                </div>
              )}

              <button className="btn btn--primary" onClick={handleAnalysis} disabled={isAnalyzing || !url.trim()}>
                <Shield size={16} />
                {isAnalyzing ? 'Scanning...' : 'Scan Website'}
              </button>
            </div>
          </div>
        )}

        {/* Code Analysis Form */}
        {analysisMode === 'codeSnippet' && (
          <div className="card card--glass analysis-card">
            <div className="analysis-form">
              <div className="form-group">
                <label htmlFor="language" className="input-label">
                  Programming Language
                </label>
                <select
                  id="language"
                  className="input"
                  value={codeLanguage}
                  onChange={(e) => setCodeLanguage(e.target.value)}
                  disabled={isAnalyzing}
                >
                  <option value="python">Python</option>
                  <option value="javascript">JavaScript</option>
                  <option value="java">Java</option>
                  <option value="php">PHP</option>
                  <option value="ruby">Ruby</option>
                </select>
              </div>

              <div className="form-group">
                <label htmlFor="code" className="input-label">
                  Code Snippet <span className="required">*</span>
                </label>
                <textarea
                  id="code"
                  className="input"
                  placeholder="Paste your code here..."
                  value={codeSnippet}
                  onChange={(e) => setCodeSnippet(e.target.value)}
                  disabled={isAnalyzing}
                  rows={6}
                />
              </div>

              {error && (
                <div className="alert alert--error">
                  <AlertTriangle size={16} />
                  {error}
                </div>
              )}

              <button className="btn btn--primary" onClick={handleAnalysis} disabled={isAnalyzing || !codeSnippet.trim()}>
                <Code size={16} />
                {isAnalyzing ? 'Analyzing...' : 'Analyze Code'}
              </button>
            </div>
          </div>
        )}

        {/* Results Section */}
        {result && (
          <div className="analysis-results">
            {/* Status Card */}
            <div
              className="status-card"
              style={{
                borderLeftColor: getSeverityColor(result.severity),
                backgroundColor: result.isVulnerable ? 'rgba(239, 68, 68, 0.05)' : 'rgba(34, 197, 94, 0.05)',
              }}
            >
              <div className="status-header">
                <div className="status-title">
                  {result.isVulnerable ? (
                    <AlertTriangle size={24} style={{ color: getSeverityColor(result.severity) }} />
                  ) : (
                    <CheckCircle size={24} style={{ color: getSeverityColor(result.severity) }} />
                  )}
                  <div>
                    <h2>{result.vulnerabilityType}</h2>
                    <p className="status-subtext">
                      {result.isVulnerable ? 'VULNERABLE' : 'SAFE'} • Severity:{' '}
                      <span style={{ color: getSeverityColor(result.severity), fontWeight: 'bold' }}>
                        {result.severity.toUpperCase()}
                      </span>
                    </p>
                  </div>
                </div>
              </div>

              <div className="status-content">
                <div className="explanation-box">
                  <p>{result.explanation}</p>
                </div>

                <div className="meta-info">
                  <div className="meta-item">
                    <span className="meta-label">CWE ID:</span>
                    <span className="meta-value">{result.cweId}</span>
                  </div>
                  <div className="meta-item">
                    <span className="meta-label">OWASP Category:</span>
                    <span className="meta-value">{result.owasp}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="result-tabs">
              <button
                className={`tab-btn ${activeTab === 'overview' ? 'active' : ''}`}
                onClick={() => setActiveTab('overview')}
              >
                Overview
              </button>
              {result.codeSnippets && result.codeSnippets.length > 0 && (
                <button
                  className={`tab-btn ${activeTab === 'code' ? 'active' : ''}`}
                  onClick={() => setActiveTab('code')}
                >
                  Code Examples
                </button>
              )}
              <button
                className={`tab-btn ${activeTab === 'remediation' ? 'active' : ''}`}
                onClick={() => setActiveTab('remediation')}
              >
                Remediation
              </button>
            </div>

            {/* Overview Tab */}
            {activeTab === 'overview' && (
              <div className="card card--glass">
                <div className="ml-analysis-section">
                  <Brain size={20} />
                  <h3>ML-based Anomaly Detection</h3>
                </div>

                <div className="ml-analysis-content">
                  <div className="ml-grid">
                    <div className="ml-item">
                      <span className="ml-label">Detection Model:</span>
                      <span className="ml-value">{result.mlModel === 'isolationForest' ? 'Isolation Forest' : 'LightGBM'}</span>
                    </div>
                    <div className="ml-item">
                      <span className="ml-label">Anomaly Score:</span>
                      <span className="ml-score">{result.anomalyScore}/100</span>
                    </div>
                    <div className="ml-item">
                      <span className="ml-label">Risk Level:</span>
                      <span className="ml-risk" style={{ color: getSeverityColor(getRiskLevel(result.anomalyScore)) }}>
                        {getRiskLevel(result.anomalyScore)}
                      </span>
                    </div>
                  </div>

                  <div className="progress-bar">
                    <div 
                      className="progress-fill" 
                      style={{ 
                        width: `${result.anomalyScore}%`,
                        backgroundColor: getSeverityColor(getRiskLevel(result.anomalyScore))
                      }}
                    />
                  </div>
                </div>

                {result.potentialAttacks && result.potentialAttacks.length > 0 && (
                  <div className="potential-attacks">
                    <h4>Potential Attack Vectors</h4>
                    <ul>
                      {result.potentialAttacks.map((attack, i) => (
                        <li key={i}>{attack}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            )}

            {/* Code Examples Tab */}
            {activeTab === 'code' && result.codeSnippets && result.codeSnippets.length > 0 && (
              <div className="card card--glass">
                <div className="code-snippets-section">
                  <Code size={20} />
                  <h3>Code Examples & Secure Implementations</h3>
                </div>

                <div className="code-snippets-list">
                  {result.codeSnippets.map((snippet, index) => (
                    <div key={index} className="code-snippet-container">
                      <h4 className="code-snippet-title">{snippet.title}</h4>

                      <div className="code-comparison">
                        <div className="code-section vulnerable">
                          <div className="code-header">
                            <span className="code-status vulnerable">❌ Vulnerable Code</span>
                          </div>
                          <pre className="code-block"><code>{snippet.vulnerable}</code></pre>
                          <button
                            className="copy-btn"
                            onClick={() => copyToClipboard(snippet.vulnerable, index * 2)}
                          >
                            <Copy size={14} />
                            {copiedIndex === index * 2 ? 'Copied!' : 'Copy'}
                          </button>
                        </div>

                        <div className="code-divider"></div>

                        <div className="code-section secure">
                          <div className="code-header">
                            <span className="code-status secure">✅ Secure Code</span>
                          </div>
                          <pre className="code-block"><code>{snippet.secure}</code></pre>
                          <button
                            className="copy-btn"
                            onClick={() => copyToClipboard(snippet.secure, index * 2 + 1)}
                          >
                            <Copy size={14} />
                            {copiedIndex === index * 2 + 1 ? 'Copied!' : 'Copy'}
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Remediation Tab */}
            {activeTab === 'remediation' && (
              <div className="card card--glass">
                <div className="remediation-section">
                  <Shield size={20} />
                  <h3>Remediation Steps</h3>
                </div>

                <div className="remediation-list">
                  {result.remediations.map((remediation, index) => (
                    <div key={index} className="remediation-item">
                      <div className="remediation-number">{index + 1}</div>
                      <div className="remediation-content">
                        <p>{remediation}</p>
                        <button
                          className="copy-btn"
                          onClick={() => copyToClipboard(remediation, index + 100)}
                        >
                          <Copy size={14} />
                          {copiedIndex === index + 100 ? 'Copied!' : 'Copy'}
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Download Buttons */}
            <div className="action-buttons">
              <button className="btn btn--primary btn--full" onClick={() => {
                setUrl('');
                setPayload('');
                setCodeSnippet('');
                setResult(null);
                setError('');
              }}>
                <Zap size={16} />
                New Analysis
              </button>
              <button className="btn btn--secondary btn--full" onClick={downloadPDFReport}>
                <Download size={16} />
                Download PDF Report
              </button>
            </div>
          </div>
        )}

        {/* Loading State */}
        {isAnalyzing && (
          <div className="loading-state">
            <div className="loading-spinner"></div>
            <p>Analyzing...</p>
          </div>
        )}
      </div>
    </div>
  );
}

export default VulnerabilityAnalysis;
