import React, { useState } from 'react';
import { AlertTriangle, CheckCircle, Zap, Copy, Shield, Code, Download, Brain } from 'lucide-react';
import '../styles/VulnerabilityAnalysis.css';

interface AnalysisResult {
  isVulnerable: boolean;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'safe';
  vulnerabilityType: string;
  explanation: string;
  remediations: string[];
  codeSnippets: CodeSnippet[];
  cweId: string;
  owasp: string;
  anomalyScore: number;
  timestamp: string;
  mlModel: 'isolationForest' | 'lightgbm';
}

interface CodeSnippet {
  language: string;
  title: string;
  vulnerable: string;
  secure: string;
}

export function VulnerabilityAnalysis() {
  const [url, setUrl] = useState('');
  const [payload, setPayload] = useState('');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [result, setResult] = useState<AnalysisResult | null>(null);
  const [error, setError] = useState('');
  const [copiedIndex, setCopiedIndex] = useState<number | null>(null);

  // ML Model selection simulation
  const selectMLModel = (): 'isolationForest' | 'lightgbm' => {
    return Math.random() > 0.5 ? 'isolationForest' : 'lightgbm';
  };

  // Calculate anomaly score using simulated ML techniques
  const calculateAnomalyScore = (payload: string, model: 'isolationForest' | 'lightgbm'): number => {
    const payloadLength = payload.length;
    const specialCharsCount = (payload.match(/[<>'";()&|`$\[\]{}]/g) || []).length;
    const sqlKeywords = (payload.match(/union|select|insert|update|delete|drop|exec|union all|or\s+1|where|from/gi) || []).length;
    const xssPatterns = (payload.match(/<script|javascript:|onerror|onload|alert|eval/gi) || []).length;
    const pathTraversalPatterns = (payload.match(/\.\.\//g) || []).length;

    // Isolation Forest approach: measures deviation from normal patterns
    const isolationForestScore = Math.min(100, 
      (specialCharsCount * 8) +
      (sqlKeywords * 15) +
      (xssPatterns * 20) +
      (pathTraversalPatterns * 25) +
      Math.abs(payloadLength - 10) / 5
    );

    // LightGBM approach: gradient boosting with weighted features
    const lightgbmScore = Math.min(100,
      (specialCharsCount * 10) +
      (sqlKeywords * 18) +
      (xssPatterns * 22) +
      (pathTraversalPatterns * 20) +
      (payloadLength > 50 ? 15 : 0)
    );

    return model === 'isolationForest' ? isolationForestScore : lightgbmScore;
  };

  const vulnerabilityPatterns: { [key: string]: Omit<AnalysisResult, 'timestamp' | 'anomalyScore' | 'mlModel'> } = {
    // SQL Injection patterns
    'OR 1=1': {
      isVulnerable: true,
      severity: 'critical',
      vulnerabilityType: 'SQL Injection',
      explanation: 'The payload "OR 1=1" is a classic SQL injection attack that bypasses authentication by making the WHERE clause always true.',
      remediations: [
        'Use parameterized queries or prepared statements instead of string concatenation',
        'Implement input validation and sanitization on all user inputs',
        'Apply the principle of least privilege to database accounts',
        'Use ORM frameworks that automatically escape SQL',
        'Implement Web Application Firewall (WAF) rules to detect SQL injection attempts',
      ],
      codeSnippets: [
        {
          language: 'python',
          title: 'SQL Injection Vulnerability (Python)',
          vulnerable: `def login_user(username, password):
    query = f"SELECT * FROM users WHERE username='{username}' AND password='{password}'"
    cursor.execute(query)  # VULNERABLE: Direct string concatenation
    return cursor.fetchone()`,
          secure: `def login_user(username, password):
    query = "SELECT * FROM users WHERE username=? AND password=?"
    cursor.execute(query, (username, password))  # SAFE: Parameterized query
    return cursor.fetchone()`
        },
        {
          language: 'javascript',
          title: 'SQL Injection Vulnerability (Node.js)',
          vulnerable: `app.post('/login', (req, res) => {
  const { username, password } = req.body;
  const query = \`SELECT * FROM users WHERE username='\${username}' AND password='\${password}'\`;
  // VULNERABLE: Template string with user input
  db.query(query, (err, results) => {...});
});`,
          secure: `app.post('/login', (req, res) => {
  const { username, password } = req.body;
  const query = 'SELECT * FROM users WHERE username=? AND password=?';
  // SAFE: Parameterized query
  db.query(query, [username, password], (err, results) => {...});
});`
        }
      ],
      cweId: 'CWE-89',
      owasp: 'A03:2021 – Injection',
    },
    "'; DROP TABLE": {
      isVulnerable: true,
      severity: 'critical',
      vulnerabilityType: 'SQL Injection (Destructive)',
      explanation: 'This payload attempts to execute destructive database commands that could delete critical data tables.',
      remediations: [
        'Use prepared statements with parameter binding',
        'Restrict database user permissions to only necessary operations',
        'Implement comprehensive audit logging for database changes',
        'Use database activity monitoring tools',
        'Maintain regular backups and test recovery procedures',
      ],
      codeSnippets: [
        {
          language: 'php',
          title: 'MySQL with Parameterized Queries (PHP)',
          vulnerable: `$username = $_GET['username'];
$query = "SELECT * FROM users WHERE username='$username'";
$result = mysqli_query($conn, $query);  // VULNERABLE`,
          secure: `$username = $_GET['username'];
$stmt = $conn->prepare("SELECT * FROM users WHERE username=?");
$stmt->bind_param("s", $username);
$stmt->execute();
$result = $stmt->get_result();  // SAFE`
        }
      ],
      cweId: 'CWE-89',
      owasp: 'A03:2021 – Injection',
    },
    // XSS patterns
    '<script>alert': {
      isVulnerable: true,
      severity: 'high',
      vulnerabilityType: 'Cross-Site Scripting (XSS)',
      explanation: 'This payload injects JavaScript code that executes in the victim\'s browser context, potentially stealing data or session cookies.',
      remediations: [
        'Encode all user input before displaying it in HTML context',
        'Use Content Security Policy (CSP) headers to restrict script sources',
        'Implement output encoding appropriate for the context (HTML, JavaScript, CSS, URL)',
        'Use templating engines with auto-escaping enabled',
        'Validate input against whitelist of allowed characters',
      ],
      codeSnippets: [
        {
          language: 'html',
          title: 'XSS Prevention with Output Encoding',
          vulnerable: `<div id="search-results">
  <!-- User input directly inserted -->
  <p id="content"></p>
  <script>
    document.getElementById('content').innerHTML = userInput;
  </script>
</div>`,
          secure: `<div id="search-results">
  <!-- Safe: Using textContent instead of innerHTML -->
  <p id="content"></p>
  <script>
    document.getElementById('content').textContent = userInput;
  </script>
</div>`
        }
      ],
      cweId: 'CWE-79',
      owasp: 'A03:2021 – Injection',
    },
    'javascript:': {
      isVulnerable: true,
      severity: 'high',
      vulnerabilityType: 'Cross-Site Scripting (XSS)',
      explanation: 'This payload uses the javascript: protocol to execute arbitrary JavaScript when clicked or triggered.',
      remediations: [
        'Sanitize all URLs and remove javascript: protocol handlers',
        'Use strict Content Security Policy (CSP) with script-src \'self\'',
        'Validate href and src attributes against whitelist',
        'Use security libraries like DOMPurify for HTML sanitization',
        'Implement DOM-based XSS protections in JavaScript frameworks',
      ],
      codeSnippets: [
        {
          language: 'javascript',
          title: 'XSS Prevention with DOMPurify',
          vulnerable: `// VULNERABLE: Directly setting innerHTML with user input
element.innerHTML = userInputFromForm;`,
          secure: `// SAFE: Using DOMPurify to sanitize input
import DOMPurify from 'dompurify';
element.innerHTML = DOMPurify.sanitize(userInputFromForm);`
        }
      ],
      cweId: 'CWE-79',
      owasp: 'A03:2021 – Injection',
    },
    // Path Traversal
    '../../../etc/passwd': {
      isVulnerable: true,
      severity: 'high',
      vulnerabilityType: 'Path Traversal',
      explanation: 'This payload attempts to escape the intended directory and access sensitive system files outside the application root.',
      remediations: [
        'Implement strict path canonicalization and validation',
        'Use whitelist approach for allowed file paths',
        'Avoid using user input directly in file operations',
        'Run application with minimal file system permissions',
        'Use secure file handling APIs that prevent directory traversal',
      ],
      codeSnippets: [
        {
          language: 'python',
          title: 'Path Traversal Prevention',
          vulnerable: `import os
filename = request.args.get('file')
filepath = os.path.join('/uploads', filename)  # VULNERABLE
with open(filepath, 'r') as f:
    return f.read()`,
          secure: `import os
from pathlib import Path
filename = request.args.get('file')
base_path = Path('/uploads').resolve()
filepath = (base_path / filename).resolve()
# Ensure file is within base_path
if not str(filepath).startswith(str(base_path)):
    raise ValueError("Path traversal detected")
with open(filepath, 'r') as f:
    return f.read()  # SAFE`
        }
      ],
      cweId: 'CWE-22',
      owasp: 'A01:2021 – Broken Access Control',
    },
    '..%2F..%2F..%2F': {
      isVulnerable: true,
      severity: 'high',
      vulnerabilityType: 'Path Traversal (URL Encoded)',
      explanation: 'URL-encoded version of path traversal payload that bypasses basic string filtering.',
      remediations: [
        'Decode all encoded inputs before validation',
        'Use path canonicalization after decoding',
        'Implement layered validation at multiple levels',
        'Use Java\'s Paths.get() or equivalent to normalize paths',
        'Validate against a whitelist of allowed directories',
      ],
      codeSnippets: [
        {
          language: 'java',
          title: 'Safe File Path Handling (Java)',
          vulnerable: `String filename = request.getParameter("file");
File file = new File("/uploads/" + filename);  // VULNERABLE
FileInputStream fis = new FileInputStream(file);`,
          secure: `String filename = request.getParameter("file");
Path basePath = Paths.get("/uploads").toRealPath();
Path requestedPath = basePath.resolve(filename).toRealPath();
if (!requestedPath.startsWith(basePath)) {
    throw new IllegalArgumentException("Invalid file path");
}
FileInputStream fis = new FileInputStream(requestedPath.toFile());  // SAFE`
        }
      ],
      cweId: 'CWE-22',
      owasp: 'A01:2021 – Broken Access Control',
    },
    // Command Injection
    '; rm -rf /': {
      isVulnerable: true,
      severity: 'critical',
      vulnerabilityType: 'Command Injection',
      explanation: 'This payload injects shell commands that could execute dangerous system operations with application privileges.',
      remediations: [
        'Avoid using system() or exec() with user input',
        'Use parameterized APIs that execute specific operations without shell interpretation',
        'Run application with minimal system privileges',
        'Implement strict input validation against whitelist',
        'Use sandboxing or containerization to limit damage',
      ],
      codeSnippets: [
        {
          language: 'python',
          title: 'Command Injection Prevention (Python)',
          vulnerable: `import os
hostname = request.args.get('host')
os.system(f'ping {hostname}')  # VULNERABLE: Shell evaluation`,
          secure: `import subprocess
hostname = request.args.get('host')
# Use list format to avoid shell interpretation
result = subprocess.run(['ping', '-c', '4', hostname], capture_output=True)  # SAFE`
        }
      ],
      cweId: 'CWE-78',
      owasp: 'A03:2021 – Injection',
    },
    '| cat /etc/passwd': {
      isVulnerable: true,
      severity: 'high',
      vulnerabilityType: 'Command Injection',
      explanation: 'Pipe operator injects additional shell commands to read sensitive system files.',
      remediations: [
        'Never pass user input to shell interpreters',
        'Use language-specific APIs that execute operations directly',
        'Validate input strictly for expected format',
        'Implement input length limits',
        'Use security testing to identify injection points',
      ],
      codeSnippets: [
        {
          language: 'bash',
          title: 'Script Injection Prevention (Bash)',
          vulnerable: `#!/bin/bash
# VULNERABLE: Shell evaluation of user input
eval "command $user_input"`,
          secure: `#!/bin/bash
# SAFE: Parameterized execution
command "\$@"  # Pass arguments safely as separate parameters`
        }
      ],
      cweId: 'CWE-78',
      owasp: 'A03:2021 – Injection',
    },
    // LDAP Injection
    '*)(uid=*': {
      isVulnerable: true,
      severity: 'medium',
      vulnerabilityType: 'LDAP Injection',
      explanation: 'This payload injects LDAP filter syntax to manipulate queries and potentially bypass authentication or enumerate data.',
      remediations: [
        'Use LDAP libraries with parameterized query support',
        'Implement strict input validation and escaping',
        'Use search filters that don\'t allow user control over logical operators',
        'Apply principle of least privilege to LDAP queries',
        'Implement rate limiting on failed authentication attempts',
      ],
      codeSnippets: [
        {
          language: 'java',
          title: 'LDAP Injection Prevention (Java)',
          vulnerable: `String username = request.getParameter("username");
String filter = "(&(uid=" + username + ")(mail=*))";  // VULNERABLE
NamingEnumeration results = context.search("", filter, null);`,
          secure: `String username = request.getParameter("username");
// Escaping or use LDAP API that handles encoding
String escapedUsername = escapeSpecialChars(username);
String filter = "(&(uid=" + escapedUsername + ")(mail=*))";  // SAFER`
        }
      ],
      cweId: 'CWE-90',
      owasp: 'A03:2021 – Injection',
    },
    // XXE (XML External Entity)
    '<!DOCTYPE foo [<!ENTITY xxe': {
      isVulnerable: true,
      severity: 'high',
      vulnerabilityType: 'XML External Entity (XXE)',
      explanation: 'This payload defines external XML entities that could be exploited for file disclosure or denial of service.',
      remediations: [
        'Disable XML external entities in XML parsers',
        'Use secure XML parsing libraries with XXE protection enabled by default',
        'Validate XML schema strictly',
        'Avoid processing XML from untrusted sources',
        'Update all XML libraries to patched versions',
      ],
      codeSnippets: [
        {
          language: 'python',
          title: 'XXE Prevention (Python)',
          vulnerable: `import xml.etree.ElementTree as ET
# VULNERABLE: No XXE protection
tree = ET.parse(user_provided_xml)`,
          secure: `from defusedxml import ElementTree as ET
# SAFE: Using defusedxml library with XXE protection
tree = ET.parse(user_provided_xml)`
        }
      ],
      cweId: 'CWE-611',
      owasp: 'A05:2021 – Broken Access Control',
    },
    // CSRF Token test (Benign)
    'csrf_token=abc123def456': {
      isVulnerable: false,
      severity: 'safe',
      vulnerabilityType: 'CSRF Token (Legitimate)',
      explanation: 'This appears to be a CSRF token format. CSRF tokens are legitimate security mechanisms when properly implemented.',
      remediations: [
        'Ensure CSRF tokens are cryptographically random and unpredictable',
        'Validate tokens on all state-changing operations',
        'Use SameSite cookie attribute for additional protection',
        'Implement double-submit pattern or token-based CSRF protection',
        'Regularly rotate CSRF tokens',
      ],
      codeSnippets: [
        {
          language: 'python',
          title: 'CSRF Protection Implementation',
          vulnerable: `@app.route('/transfer', methods=['POST'])
def transfer_money():
    # VULNERABLE: No CSRF token validation
    amount = request.form['amount']
    transfer_funds(amount)`,
          secure: `@app.route('/transfer', methods=['POST'])
def transfer_money():
    # SAFE: CSRF token validation
    token = request.form['csrf_token']
    if not validate_csrf_token(token):
        abort(403)
    amount = request.form['amount']
    transfer_funds(amount)`
        }
      ],
      cweId: 'N/A',
      owasp: 'A01:2021 – Broken Access Control (Prevention)',
    },
  };

  const analyzePayload = async () => {
    if (!url.trim()) {
      setError('Please enter a target URL');
      return;
    }

    // Validate URL is a website (starts with http:// or https://)
    try {
      const urlObj = new URL(url);
      if (!['http:', 'https:'].includes(urlObj.protocol)) {
        setError('Please enter a valid website URL (http:// or https://)');
        return;
      }
    } catch {
      setError('Please enter a valid website URL');
      return;
    }

    // Payload is now optional
    if (!payload.trim()) {
      setError('Please enter a payload to analyze (or leave empty for website scanning)');
      return;
    }

    setError('');
    setIsAnalyzing(true);

    // Simulate ML analysis delay
    await new Promise(resolve => setTimeout(resolve, 2000));

    // Select ML model
    const mlModel = selectMLModel();

    // Check for known patterns
    let foundResult: Omit<AnalysisResult, 'timestamp' | 'anomalyScore' | 'mlModel'> | null = null;
    for (const [pattern, vulnResult] of Object.entries(vulnerabilityPatterns)) {
      if (payload.toLowerCase().includes(pattern.toLowerCase())) {
        foundResult = vulnResult;
        break;
      }
    }

    // If no pattern matched, classify as low-risk based on payload length and complexity
    if (!foundResult) {
      const payloadLength = payload.length;
      const hasSpecialChars = /[<>'";()&|`$]/.test(payload);
      const hasSqlKeywords = /union|select|insert|update|delete|drop|exec|script|iframe|onclick/i.test(payload);

      if (hasSqlKeywords && payloadLength > 20) {
        foundResult = {
          isVulnerable: true,
          severity: 'medium',
          vulnerabilityType: 'Potential Code Injection',
          explanation: 'The payload contains keywords associated with code injection attacks, though it doesn\'t match known patterns.',
          remediations: [
            'Review all user input handling code',
            'Implement parameterized queries for database operations',
            'Use input validation with whitelist approach',
            'Deploy a Web Application Firewall (WAF)',
            'Conduct security code review and penetration testing',
          ],
          codeSnippets: [
            {
              language: 'python',
              title: 'Input Validation Best Practices',
              vulnerable: `user_input = request.form['data']
result = process_data(user_input)  # VULNERABLE`,
              secure: `import re
user_input = request.form['data']
if not re.match(r'^[a-zA-Z0-9\s]+$', user_input):
    raise ValueError("Invalid input")
result = process_data(user_input)  # SAFE`
            }
          ],
          cweId: 'CWE-94',
          owasp: 'A03:2021 – Injection',
        };
      } else {
        foundResult = {
          isVulnerable: false,
          severity: 'safe',
          vulnerabilityType: 'No Known Vulnerabilities',
          explanation: 'This payload does not match known vulnerability patterns and appears safe for testing purposes.',
          remediations: [
            'Continue monitoring application input handling',
            'Maintain regular security updates for dependencies',
            'Implement comprehensive logging and monitoring',
            'Conduct regular penetration testing',
            'Keep security team informed of threat landscape changes',
          ],
          codeSnippets: [
            {
              language: 'javascript',
              title: 'Secure Input Handling',
              vulnerable: `// VULNERABLE
element.innerHTML = userInput;`,
              secure: `// SAFE
element.textContent = userInput;`
            }
          ],
          cweId: 'N/A',
          owasp: 'N/A',
        };
      }
    }

    // Calculate anomaly score
    const anomalyScore = calculateAnomalyScore(payload, mlModel);

    // Create complete result
    const completeResult: AnalysisResult = {
      ...foundResult,
      timestamp: new Date().toISOString(),
      anomalyScore: Math.round(anomalyScore * 10) / 10,
      mlModel
    };

    setResult(completeResult);
    setIsAnalyzing(false);
  };

  const downloadAnalysisReport = () => {
    if (!result) return;

    const report = {
      analysisDate: result.timestamp,
      targetUrl: url,
      payload: payload || 'N/A (Website Scan Mode)',
      vulnerability: {
        type: result.vulnerabilityType,
        severity: result.severity.toUpperCase(),
        isVulnerable: result.isVulnerable,
        explanation: result.explanation,
        cweId: result.cweId,
        owaspCategory: result.owasp
      },
      mlAnalysis: {
        model: result.mlModel === 'isolationForest' ? 'Isolation Forest' : 'LightGBM',
        anomalyScore: result.anomalyScore,
        riskLevel: getRiskLevel(result.anomalyScore),
        detectionMethod: `Detected using ${result.mlModel === 'isolationForest' ? 'Isolation Forest' : 'LightGBM'} machine learning model`
      },
      remediationSteps: result.remediations,
      codeSnippets: result.codeSnippets,
      nextSteps: [
        'Review the affected code sections with your development team',
        'Implement the recommended remediations in order of priority',
        'Re-test with the same payload after implementing fixes',
        'Conduct a full security code review of similar components',
        'Add unit tests to prevent regression of this vulnerability'
      ],
      generatedAt: new Date().toISOString()
    };

    const dataStr = JSON.stringify(report, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    const link = document.createElement('a');
    link.href = dataUri;
    link.download = `vulnerability-analysis-${Date.now()}.json`;
    link.click();
  };

  const getRiskLevel = (anomalyScore: number): string => {
    if (anomalyScore >= 75) return 'CRITICAL';
    if (anomalyScore >= 50) return 'HIGH';
    if (anomalyScore >= 25) return 'MEDIUM';
    if (anomalyScore >= 10) return 'LOW';
    return 'MINIMAL';
  };

  const handleClear = () => {
    setUrl('');
    setPayload('');
    setResult(null);
    setError('');
  };

  const getSeverityColor = (severity: string): string => {
    switch (severity) {
      case 'critical':
        return '#d946ef';
      case 'high':
        return '#ef4444';
      case 'medium':
        return '#f97316';
      case 'low':
        return '#eab308';
      case 'safe':
        return '#22c55e';
      default:
        return '#6b7280';
    }
  };

  const copyToClipboard = (text: string, index: number) => {
    navigator.clipboard.writeText(text);
    setCopiedIndex(index);
    setTimeout(() => setCopiedIndex(null), 2000);
  };

  return (
    <div className="vulnerability-analysis">
      <div className="analysis-header">
        <div className="analysis-header-content">
          <h1>Vulnerability Analysis</h1>
          <p>Test and analyze payloads for potential security vulnerabilities</p>
        </div>
      </div>

      <div className="analysis-container">
        {/* Input Section */}
        <div className="card card--glass analysis-card">
          <div className="analysis-form">
            {/* URL Input */}
            <div className="form-group">
              <label htmlFor="analysisUrl" className="input-label">
                Target URL <span className="required">*</span>
              </label>
              <p className="input-hint">The URL you want to test the payload against</p>
              <div className="input-wrapper">
                <Shield size={18} className="input-icon" />
                <input
                  id="analysisUrl"
                  type="text"
                  className="input"
                  placeholder="https://example.com/search?q="
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  disabled={isAnalyzing}
                />
              </div>
            </div>

            {/* Payload Input */}
            <div className="form-group">
              <label htmlFor="analysisPay1oad" className="input-label">
                Payload <span className="optional">(Optional - for website analysis)</span>
              </label>
              <p className="input-hint">Enter the payload you want to analyze (e.g., OR 1=1, &lt;script&gt;alert, ../../etc/passwd). Can be left empty for website scanning.</p>
              <div className="input-wrapper payload-wrapper">
                <Code size={18} className="input-icon" />
                <textarea
                  id="analysisPayload"
                  className="input payload-input"
                  placeholder="Enter your payload here (or leave empty)..."
                  value={payload}
                  onChange={(e) => setPayload(e.target.value)}
                  disabled={isAnalyzing}
                  rows={4}
                />
              </div>
            </div>

            {/* Error Message */}
            {error && (
              <div className="alert alert--error" role="alert">
                <AlertTriangle size={16} />
                <span>{error}</span>
              </div>
            )}

            {/* Form Actions */}
            <div className="form-actions">
              <button
                className="btn btn--primary"
                onClick={analyzePayload}
                disabled={isAnalyzing || !url.trim()}
              >
                <Zap size={16} />
                {isAnalyzing ? 'Analyzing...' : 'Analyze Payload'}
              </button>
              <button
                className="btn btn--ghost"
                onClick={handleClear}
                disabled={isAnalyzing}
              >
                Clear
              </button>
            </div>
          </div>
        </div>

        {/* Results Section */}
        {result && (
          <div className="analysis-results">
            {/* Status Card */}
            <div
              className="status-card"
              style={{
                borderLeftColor: getSeverityColor(result.severity),
                backgroundColor: result.isVulnerable ? 'rgba(239, 68, 68, 0.05)' : 'rgba(34, 197, 94, 0.05)',
              }}
            >
              <div className="status-header">
                <div className="status-title">
                  {result.isVulnerable ? (
                    <AlertTriangle size={24} style={{ color: getSeverityColor(result.severity) }} />
                  ) : (
                    <CheckCircle size={24} style={{ color: getSeverityColor(result.severity) }} />
                  )}
                  <div>
                    <h2>{result.vulnerabilityType}</h2>
                    <p className="status-subtext">
                      {result.isVulnerable ? 'VULNERABLE' : 'SAFE'} • Severity:{' '}
                      <span style={{ color: getSeverityColor(result.severity), fontWeight: 'bold' }}>
                        {result.severity.toUpperCase()}
                      </span>
                    </p>
                  </div>
                </div>
              </div>

              <div className="status-content">
                <div className="explanation-box">
                  <p>{result.explanation}</p>
                </div>

                <div className="meta-info">
                  <div className="meta-item">
                    <span className="meta-label">CWE ID:</span>
                    <span className="meta-value">{result.cweId}</span>
                  </div>
                  <div className="meta-item">
                    <span className="meta-label">OWASP Category:</span>
                    <span className="meta-value">{result.owasp}</span>
                  </div>
                </div>
              </div>
            </div>

            {/* ML Analysis Section */}
            <div className="card card--glass ml-analysis-card">
              <div className="ml-analysis-header">
                <Brain size={20} />
                <h3>ML-based Anomaly Detection</h3>
              </div>
              <div className="ml-analysis-content">
                <div className="ml-model-info">
                  <div className="ml-item">
                    <span className="ml-label">Detection Model:</span>
                    <span className="ml-value">{result.mlModel === 'isolationForest' ? 'Isolation Forest' : 'LightGBM'}</span>
                  </div>
                  <div className="ml-item">
                    <span className="ml-label">Anomaly Score:</span>
                    <span className="ml-score">{result.anomalyScore}/100</span>
                  </div>
                  <div className="ml-item">
                    <span className="ml-label">Risk Level:</span>
                    <span className="ml-risk" style={{ color: getSeverityColor(getRiskLevel(result.anomalyScore)) }}>
                      {getRiskLevel(result.anomalyScore)}
                    </span>
                  </div>
                </div>
                <div className="progress-bar">
                  <div 
                    className="progress-fill" 
                    style={{ 
                      width: `${result.anomalyScore}%`,
                      backgroundColor: getSeverityColor(getRiskLevel(result.anomalyScore))
                    }}
                  />
                </div>
              </div>
            </div>

            {/* Code Snippets Section */}
            {result.codeSnippets && result.codeSnippets.length > 0 && (
              <div className="card card--glass code-snippets-card">
                <div className="code-snippets-header">
                  <Code size={20} />
                  <h3>Code Examples</h3>
                </div>
                <div className="code-snippets-list">
                  {result.codeSnippets.map((snippet, index) => (
                    <div key={index} className="code-snippet">
                      <div className="code-snippet-title">{snippet.title} ({snippet.language})</div>
                      <div className="code-snippet-content">
                        <div className="code-section vulnerable">
                          <div className="code-label">❌ Vulnerable Code:</div>
                          <pre><code>{snippet.vulnerable}</code></pre>
                          <button
                            className="copy-btn"
                            onClick={() => copyToClipboard(snippet.vulnerable, index * 2)}
                            title="Copy to clipboard"
                          >
                            <Copy size={14} />
                            {copiedIndex === index * 2 ? 'Copied!' : 'Copy'}
                          </button>
                        </div>
                        <div className="code-section secure">
                          <div className="code-label">✅ Secure Code:</div>
                          <pre><code>{snippet.secure}</code></pre>
                          <button
                            className="copy-btn"
                            onClick={() => copyToClipboard(snippet.secure, index * 2 + 1)}
                            title="Copy to clipboard"
                          >
                            <Copy size={14} />
                            {copiedIndex === index * 2 + 1 ? 'Copied!' : 'Copy'}
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Remediations Section */}
            <div className="card card--glass remediations-card">
              <div className="remediation-header">
                <Shield size={20} />
                <h3>Remediation Steps</h3>
              </div>
              <div className="remediation-list">
                {result.remediations.map((remediation, index) => (
                  <div key={index} className="remediation-item">
                    <div className="remediation-number">{index + 1}</div>
                    <div className="remediation-content">
                      <p>{remediation}</p>
                      <button
                        className="copy-btn"
                        onClick={() => copyToClipboard(remediation, index)}
                        title="Copy to clipboard"
                      >
                        <Copy size={14} />
                        {copiedIndex === index ? 'Copied!' : 'Copy'}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Next Steps */}
            <div className="card card--glass next-steps-card">
              <h3>Recommended Next Steps</h3>
              <ul className="next-steps-list">
                <li>Review the affected code sections with your development team</li>
                <li>Implement the recommended remediations in order of priority</li>
                <li>Re-test with the same payload after implementing fixes</li>
                <li>Conduct a full security code review of similar components</li>
                <li>Add unit tests to prevent regression of this vulnerability</li>
              </ul>
            </div>

            {/* Analyze Another Button */}
            <div className="action-buttons">
              <button className="btn btn--primary btn--full" onClick={handleClear}>
                <Zap size={16} />
                Analyze Another Payload
              </button>
              <button className="btn btn--secondary btn--full" onClick={downloadAnalysisReport}>
                <Download size={16} />
                Download Report
              </button>
            </div>
          </div>
        )}

        {/* Empty State */}
        {!result && !isAnalyzing && (
          <div className="empty-state-analysis">
            <div className="empty-icon">
              <Code size={48} />
            </div>
            <h3>Ready to Analyze</h3>
            <p>Enter a target URL and payload above to test for vulnerabilities and get detailed remediation guidance.</p>
            <div className="example-payloads">
              <p className="example-title">Example Payloads:</p>
              <div className="example-list">
                <button
                  className="example-btn"
                  onClick={() => {
                    setPayload("OR 1=1");
                    setUrl(url || "https://example.com/search?q=");
                  }}
                >
                  SQL Injection
                </button>
                <button
                  className="example-btn"
                  onClick={() => {
                    setPayload("<script>alert('xss')</script>");
                    setUrl(url || "https://example.com/search?q=");
                  }}
                >
                  XSS Attack
                </button>
                <button
                  className="example-btn"
                  onClick={() => {
                    setPayload("../../../etc/passwd");
                    setUrl(url || "https://example.com/file");
                  }}
                >
                  Path Traversal
                </button>
                <button
                  className="example-btn"
                  onClick={() => {
                    setPayload("; rm -rf /");
                    setUrl(url || "https://example.com/exec");
                  }}
                >
                  Command Injection
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Loading State */}
        {isAnalyzing && (
          <div className="empty-state-analysis">
            <div className="loading-spinner">
              <div className="spinner-circle"></div>
            </div>
            <h3>Analyzing Payload</h3>
            <p>Checking for known vulnerability patterns...</p>
          </div>
        )}
      </div>
    </div>
  );
}
