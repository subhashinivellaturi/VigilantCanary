import React, { useState, lazy, Suspense, useRef, useEffect } from "react";
import { motion } from "framer-motion";
import { AlertCircle, CheckCircle, AlertTriangle, Shield, Wifi, WifiOff, Globe, Search } from "lucide-react";
import { SecurityCard, StatusCard, ActionCard } from './design';
import { Button } from './ui/Button';
import { useToast } from './ui/Toast';
// Chatbot is now hosted in the global sidebar
const ExecutiveSummaryPanel = lazy(() =>
  import("./ExecutiveSummaryPanel").then((m) => ({ default: m.ExecutiveSummaryPanel }))
);
const FindingsDisplay = lazy(() =>
  import("./FindingsDisplay").then((m) => ({ default: m.FindingsDisplay }))
);
const DashboardSummary = lazy(() =>
  import("./DashboardSummary").then((m) => ({ default: m.DashboardSummary }))
);
const RecentScans = lazy(() =>
  import("./RecentScans").then((m) => ({ default: m.RecentScans }))
);

import { generatePDFReport } from "../utils/pdfGenerator";
import { API_URL } from "../api/client";

interface ProductionScanResponse {
  url: string;
  scan_timestamp: string;
  vulnerabilities_found: number;
  vulnerabilities: Array<{
    id: string;
    timestamp: string;
    vulnerability_name: string;
    severity: string;
    affected_url: string;
    scan_type: string;
    cvss_score: number;
    description: string;
    confidence: number;
  }>;
  status: string;
  scan_id: number;
  executive_summary: {
    risk_score_0_to_100: number;
    total_findings: number;
    critical_count: number;
    high_count: number;
    medium_count: number;
    low_count: number;
    executive_summary_text: string;
    overall_risk_status: string;
    scan_mode: string;
  };
  disclaimer: string;
  scan_mode: string;
}

export function VulnerabilityDetectionSystem() {
  const [endpoint, setEndpoint] = useState("");
  const [payload, setPayload] = useState("");
  const [loading, setLoading] = useState(false);
  const [productionResponse, setProductionResponse] = useState<ProductionScanResponse | null>(null);
  const resultsRef = useRef<HTMLDivElement>(null);
  const { showToast } = useToast();
  // Used to force RecentScans to re-mount on scan completion
  const [scanHistoryKey, setScanHistoryKey] = useState(0);

  // Port scanning state
  const [targetHost, setTargetHost] = useState("");
  const [portScanLoading, setPortScanLoading] = useState(false);
  const [portScanResult, setPortScanResult] = useState<any>(null);

  // Subdomain enumeration state
  const [baseDomain, setBaseDomain] = useState("");
  const [subdomainLoading, setSubdomainLoading] = useState(false);
  const [subdomainResult, setSubdomainResult] = useState<any>(null);

  // Auto-scroll to results when scan completes
  useEffect(() => {
    if (productionResponse && resultsRef.current) {
      setTimeout(() => {
        resultsRef.current?.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 500);
    }
  }, [productionResponse]);

  const handleScan = async () => {
    if (!endpoint.trim()) {
      showToast('Please enter an endpoint URL', 'error');
      return;
    }

    setLoading(true);
    setProductionResponse(null);

    try {
      // Use the main scan endpoint
      const response = await fetch(`${API_URL}/scan`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          url: endpoint,
        }),
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.statusText}`);
      }

      const data: ProductionScanResponse = await response.json();
      setProductionResponse(data);
      setPayload(""); // Clear payload after scan
      showToast(`Scan completed for ${endpoint}`, 'success');
    } catch (err) {
      const msg = err instanceof Error ? err.message : "Scan failed";
      showToast(msg, 'error');
      setProductionResponse(null);
    } finally {
      setLoading(false);
      window.dispatchEvent(new Event('scanCompleted'));
      setScanHistoryKey(prev => prev + 1); // Force RecentScans to update
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !loading) {
      handleScan();
    }
  };

  const handlePortScan = async () => {
    if (!targetHost.trim()) {
      showToast('Please enter a target host', 'error');
      return;
    }

    setPortScanLoading(true);
    setPortScanResult(null);

    try {
      const response = await fetch(`${API_URL}/port-scan`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          target: targetHost,
        }),
      });

      if (!response.ok) {
        throw new Error(`Port scan failed: ${response.statusText}`);
      }

      const data = await response.json();
      setPortScanResult(data);
      showToast('Port scan completed', 'success');
    } catch (err) {
      const msg = err instanceof Error ? err.message : "Port scan failed";
      showToast(msg, 'error');
    } finally {
      setPortScanLoading(false);
      window.dispatchEvent(new Event('scanCompleted'));
      setScanHistoryKey(prev => prev + 1);
    }
  };

  const handlePortScanKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !portScanLoading) {
      handlePortScan();
    }
  };

  const handleSubdomainEnumeration = async () => {
    if (!baseDomain.trim()) {
      showToast('Please enter a base domain', 'error');
      return;
    }

    setSubdomainLoading(true);
    setSubdomainResult(null);

    try {
      const response = await fetch(`${API_URL}/enumerate-subdomains`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          base_domain: baseDomain,
          use_brute_force: true,
        }),
      });

      if (!response.ok) {
        throw new Error(`Subdomain enumeration failed: ${response.statusText}`);
      }

      const data = await response.json();
      setSubdomainResult(data);
      showToast('Subdomain enumeration completed', 'success');
    } catch (err) {
      const msg = err instanceof Error ? err.message : "Subdomain enumeration failed";
      showToast(msg, 'error');
    } finally {
      setSubdomainLoading(false);
      window.dispatchEvent(new Event('scanCompleted'));
      setScanHistoryKey(prev => prev + 1);
    }
  };

  const handleSubdomainKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !subdomainLoading) {
      handleSubdomainEnumeration();
    }
  };

  // Generate system prompt based on scan state
  const getChatbotPrompt = () => {
    if (productionResponse && productionResponse.executive_summary) {
      const summary = productionResponse.executive_summary;
      return `You are a friendly and educational Web Application Security Assistant. 
The user just performed a website scan with these results:
- Risk Status: ${summary.overall_risk_status || 'Unknown'}
- Risk Score: ${summary.risk_score_0_to_100 || 0}/100
- Total Findings: ${summary.total_findings || 0}
- Critical: ${summary.critical_count || 0}, High: ${summary.high_count || 0}, Medium: ${summary.medium_count || 0}, Low: ${summary.low_count || 0}
- Scan Mode: ${summary.scan_mode === "passive_only" ? "Passive (no payloads)" : "Active (with payloads)"}

Executive Summary: ${summary.executive_summary_text || 'No summary available'}

Your role:
1. Explain the scan results in simple, non-technical language
2. Help them understand what each finding means
3. Provide actionable remediation advice for each vulnerability
4. Prioritize which fixes to address first based on severity
5. Be encouraging and supportive

Tone: Educational, supportive, non-threatening. Make security accessible.`;
    } else {
      return `You are a friendly and educational Web Application Security Assistant.
The user hasn't scanned a website yet, but you can still help!

Your role:
1. Answer general security questions (SQL Injection, XSS, CSRF, etc.)
2. Explain how the scanning process works
3. Guide them through using the vulnerability scanner
4. Answer questions about web security best practices
5. Be encouraging and make security accessible

Tone: Educational, friendly, supportive, encouraging.`;
    }
  };

  return (
    <div className="vds-main-layout">
      {/* LEFT PANEL - MAIN CONTENT */}
      <motion.div
        className="vds-left-panel"
        initial={{ opacity: 0, x: -30 }}
        animate={{ opacity: 1, x: 0 }}
      >
        {/* HEADER SECTION */}
        <motion.section
          className="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 border-b border-slate-700 shadow-lg"
          initial={{ opacity: 0, y: -30 }}
          animate={{ opacity: 1, y: 0 }}
        >
          <div className="max-w-7xl mx-auto px-6 py-8">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-4">
                <div className="p-3 bg-cyan-500/10 rounded-xl border border-cyan-500/20">
                  <Shield size={32} className="text-cyan-400" />
                </div>
                <div>
                  <h1 className="text-2xl font-bold text-white tracking-tight">
                    Vigilant Canary
                  </h1>
                  <p className="text-slate-400 text-sm mt-1">
                    Production-Grade Web Vulnerability Scanner ‚Ä¢ OWASP-Aligned
                  </p>
                </div>
              </div>
              
              <div className="flex items-center space-x-8">
                <div className="text-center">
                  <div className="text-2xl font-bold text-white">
                    {productionResponse?.vulnerabilities_found ?? 0}
                  </div>
                  <div className="text-xs text-slate-400 uppercase tracking-wide">
                    Findings
                  </div>
                </div>
                <div className="w-px h-12 bg-slate-600"></div>
                <div className="text-center">
                  <div className="text-lg font-semibold text-cyan-400">
                    PASSIVE
                  </div>
                  <div className="text-xs text-slate-400 uppercase tracking-wide">
                    Scan Mode
                  </div>
                </div>
              </div>
            </div>
          </div>
        </motion.section>

        {/* DASHBOARD SUMMARY SECTION */}
        <motion.section
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.05 }}
          className="mb-6"
        >
          <Suspense fallback={<div className="bg-white rounded-lg shadow-lg p-6 animate-pulse">
            <div className="h-8 bg-gray-200 rounded mb-4"></div>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
              {[...Array(4)].map((_, i) => (
                <div key={i} className="bg-gray-200 rounded-lg p-4 h-32"></div>
              ))}
            </div>
          </div>}>
            <DashboardSummary />
          </Suspense>
        </motion.section>

        {/* RECENT SCANS SECTION - Always visible and updates after every scan */}
        <motion.section
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.08 }}
          className="mb-6"
        >
          <RecentScans key={scanHistoryKey} />
        </motion.section>

        {/* URL SCAN INPUT SECTION */}
        <motion.section
          className="vds-input-section"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
        >
          <div className="input-header">
            <h2>Security Analysis</h2>
            <p>Scan your website for vulnerabilities and security misconfigurations</p>
          </div>

          <div className="input-container">
            <div className="input-row">
              <label className="input-label">
                üîó Website URL
              </label>
              <input
                type="text"
                value={endpoint}
                onChange={(e) => setEndpoint(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="https://example.com/api/endpoint"
                disabled={loading}
                className="vds-input"
              />
            </div>
            <div style={{ marginBottom: "12px" }}>
              <label style={{ fontSize: "0.85em", fontWeight: "600", color: "#4b5563", display: "block", marginBottom: "6px" }}>
                üíâ Injection Payload <span style={{ color: "#999", fontWeight: "normal" }}>(Optional)</span>
              </label>
              <textarea
                value={payload}
                onChange={(e) => setPayload(e.target.value)}
                placeholder="e.g., ' OR '1'='1' -- (for SQLi testing)"
                disabled={loading}
                className="vds-input"
                style={{ minHeight: "100px", resize: "vertical", fontFamily: "monospace", fontSize: "0.9em" }}
              />
              {payload?.trim() ? (
                <div style={{ fontSize: "0.8em", color: "#10b981", marginTop: "4px", display: "flex", alignItems: "center", gap: "4px" }}>
                  ‚úì Active testing enabled - will test this payload
                </div>
              ) : (
                <div style={{ fontSize: "0.8em", color: "#6b7280", marginTop: "4px", display: "flex", alignItems: "center", gap: "4px" }}>
                  ‚ÑπÔ∏è Passive scan mode - URL structure only
                </div>
              )}
            </div>
            <button
              onClick={handleScan}
              disabled={loading || !endpoint.trim()}
              className="vds-scan-btn"
            >
              {loading ? "üîç Scanning..." : "üöÄ Analyze Website"}
            </button>
          </div>

          {/* Passive Scan Indicator */}
{endpoint && !payload?.trim() && !loading && (
            <motion.div
              className="passive-scan-notice"
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.2 }}
              style={{
                marginTop: "16px",
                padding: "12px",
                background: "linear-gradient(135deg, rgba(96,165,250,0.1) 0%, rgba(147,197,253,0.1) 100%)",
                border: "1px solid rgba(96,165,250,0.3)",
                borderRadius: "8px",
                fontSize: "0.9em",
                color: "#1e40af",
                display: "flex",
                alignItems: "center",
                gap: "8px"
              }}
            >
              <span>üîí</span>
              <span><strong>Passive Scan Mode:</strong> URL structure and configuration will be analyzed without payload injection.</span>
            </motion.div>
          )}


        </motion.section>

        {/* PORT SCANNING SECTION */}
        <SecurityCard title="Port Scanning" subtitle="Scan for open ports on a target host" className="p-6">
          <div className="input-header">
            <h2>Port Scanning</h2>
            <p>Scan for open ports on a target host (Low severity risk monitoring)</p>
          </div>

          <div className="input-container">
            <div className="input-row">
              <label className="input-label">
                üåê Target Host
              </label>
              <input
                type="text"
                value={targetHost}
                onChange={(e) => setTargetHost(e.target.value)}
                onKeyPress={handlePortScanKeyPress}
                placeholder="example.com or 192.168.1.1"
                disabled={portScanLoading}
                className="vds-input"
              />
            </div>
            <Button onClick={handlePortScan} disabled={portScanLoading || !targetHost.trim()} className="vds-scan-btn">
              {portScanLoading ? "üîç Scanning Ports..." : "üîç Scan Ports"}
            </Button>
          </div>

          {portScanResult && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
            >
              <div className="flex items-center gap-2 mb-3">
                {portScanResult.open_ports.length > 0 ? (
                  <Wifi size={20} className="text-blue-600" />
                ) : (
                  <WifiOff size={20} className="text-gray-600" />
                )}
                <h3 className="font-semibold text-gray-900">
                  Port Scan Results for {portScanResult.target_host}
                </h3>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-gray-600 mb-2">Scan Summary:</p>
                  <div className="space-y-1">
                    <p className="text-sm">
                      <span className="font-medium">Total Ports Scanned:</span> {portScanResult.total_ports_scanned}
                    </p>
                    <p className="text-sm">
                      <span className="font-medium">Open Ports:</span> {portScanResult.open_ports.length}
                    </p>
                    <p className="text-sm">
                      <span className="font-medium">Scan Method:</span> {portScanResult.scan_method}
                    </p>
                  </div>
                </div>
                
                <div>
                  <p className="text-sm text-gray-600 mb-2">Open Ports:</p>
                  {portScanResult.open_ports.length > 0 ? (
                    <div className="space-y-1">
                      {portScanResult.open_ports.map((port: any, index: number) => (
                        <div key={index} className="flex justify-between items-center bg-white p-2 rounded border">
                          <span className="font-mono text-sm">{port.service} ({port.port})</span>
                          <span className="text-xs text-green-600 font-medium">OPEN</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-500 italic">No open ports detected</p>
                  )}
                </div>
              </div>
              
              <div className="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                <p className="text-xs text-yellow-800">
                  <AlertTriangle size={14} className="inline mr-1" />
                  Open ports are logged as Low severity risks in the dashboard for monitoring purposes.
                </p>
              </div>
            </motion.div>
          )}
        </SecurityCard>

        {/* SUBDOMAIN ENUMERATION SECTION */}
        <motion.section
          className="vds-input-section"
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.13 }}
        >
          <div className="input-header">
            <h2>Subdomain Enumeration</h2>
            <p>Discover subdomains for a target domain using DNS brute force</p>
          </div>

          <div className="input-container">
            <div className="input-row">
              <label className="input-label">
                üåê Base Domain
              </label>
              <input
                type="text"
                value={baseDomain}
                onChange={(e) => setBaseDomain(e.target.value)}
                onKeyPress={handleSubdomainKeyPress}
                placeholder="example.com"
                disabled={subdomainLoading}
                className="vds-input"
              />
            </div>
            <Button onClick={handleSubdomainEnumeration} disabled={subdomainLoading || !baseDomain.trim()} className="vds-scan-btn">
              {subdomainLoading ? "üîç Enumerating..." : "üîç Find Subdomains"}
            </Button>
          </div>

          {subdomainResult && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              className="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg"
            >
              <div className="flex items-center gap-2 mb-3">
                <Globe size={20} className="text-purple-600" />
                <h3 className="font-semibold text-gray-900">
                  Subdomain Enumeration Results for {subdomainResult.domain}
                </h3>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-gray-600 mb-2">Scan Summary:</p>
                  <div className="space-y-1">
                    <p className="text-sm">
                      <span className="font-medium">Total Subdomains Found:</span> {subdomainResult.total_found}
                    </p>
                    <p className="text-sm">
                      <span className="font-medium">Scan Method:</span> {subdomainResult.method}
                    </p>
                    <p className="text-sm">
                      <span className="font-medium">Scan Time:</span> {subdomainResult.scan_time}s
                    </p>
                  </div>
                </div>

                <div>
                  <p className="text-sm text-gray-600 mb-2">Discovered Subdomains:</p>
                  {subdomainResult.subdomains.length > 0 ? (
                    <div className="space-y-1 max-h-40 overflow-y-auto">
                      {subdomainResult.subdomains.map((subdomain: string, index: number) => (
                        <div key={index} className="flex justify-between items-center bg-white p-2 rounded border">
                          <span className="font-mono text-sm">{subdomain}</span>
                          <span className="text-xs text-green-600 font-medium">RESOLVES</span>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-500 italic">No subdomains found</p>
                  )}
                </div>
              </div>

              <div className="mt-3 p-2 bg-blue-50 border border-blue-200 rounded">
                <p className="text-xs text-blue-800">
                  <Search size={14} className="inline mr-1" />
                  Discovered subdomains are stored in the database and displayed in the "Discovered Domains" section of the dashboard.
                </p>
              </div>
            </motion.div>
          )}
        </motion.section>

        {/* PRODUCTION SCAN RESULTS */}
        {productionResponse && (
          <div ref={resultsRef}>
            {/* Detailed Findings */}
            {productionResponse.vulnerabilities.length > 0 ? (
              <Suspense fallback={<div className="skeleton">Loading findings...</div>}>
                <FindingsDisplay
                  findings={productionResponse.vulnerabilities.map(v => ({
                    finding_id: v.id,
                    vulnerability_type: v.vulnerability_name,
                    severity: v.severity,
                    cvss_score: v.cvss_score,
                    confidence: v.confidence,
                    description: v.description,
                    affected_url: v.affected_url,
                  }))}
                  scanMode="passive"
                />
              </Suspense>
            ) : (
              <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                style={{
                  background: "#d1fae5",
                  border: "2px solid #10b981",
                  borderRadius: "12px",
                  padding: "32px",
                  textAlign: "center",
                  marginBottom: "24px",
                }}
              >
                <CheckCircle size={48} style={{ margin: "0 auto 16px", color: "#10b981" }} />
                <h3 style={{ margin: "0 0 8px 0", color: "#065f46", fontSize: "1.3em" }}>
                  ‚úÖ No Vulnerabilities Detected
                </h3>
                <p style={{ margin: "0", color: "#065f46", fontSize: "0.95em" }}>
                  This endpoint passed the security scan!{" "}
                  {productionResponse.scan_mode === "passive_only"
                    ? "Consider testing with a payload for active vulnerability assessment."
                    : "Continue monitoring with regular security audits."}
                </p>
              </motion.div>
            )}

            {/* Disclaimer */}
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              transition={{ delay: 0.2 }}
              style={{
                background: "#fef3c7",
                border: "1px solid #fcd34d",
                borderRadius: "8px",
                padding: "12px 16px",
                fontSize: "0.85em",
                color: "#92400e",
                marginTop: "16px",
              }}
            >
              <strong>üìã Disclaimer:</strong> {productionResponse.disclaimer}
            </motion.div>
          </div>
        )}
      </motion.div>

      {/* Chatbot removed ‚Äî available in global sidebar */}
    </div>
  );
}
