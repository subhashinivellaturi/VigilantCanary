import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { VulnerabilityScanner } from '../VulnerabilityScanner';
import { ToastProvider } from '../ui/Toast';

describe('VulnerabilityScanner', () => {
  afterEach(() => {
    // restore fetch
    // @ts-ignore
    if (global.fetch && (global.fetch as any).mockRestore) {
      // vitest spies don't always add restore; clear implementation
      // @ts-ignore
      global.fetch.mockClear?.();
    }
  });

  test('runs scan and shows success toast on completion', async () => {
    // mock fetch
    // @ts-ignore
    global.fetch = vi.fn(() =>
      Promise.resolve({ ok: true, json: () => Promise.resolve({ vulnerabilities: [], scan_mode: 'quick' }) })
    );

    render(
      <ToastProvider>
        <VulnerabilityScanner />
      </ToastProvider>
    );

    const input = screen.getByPlaceholderText('https://example.com');
    const btn = screen.getByRole('button', { name: /start security scan/i });

    fireEvent.change(input, { target: { value: 'https://example.com' } });
    fireEvent.click(btn);

    await waitFor(() => expect(screen.getByText(/scan completed for https:\/\/example.com/i)).toBeInTheDocument());

    // cleanup
    // @ts-ignore
    global.fetch.mockClear?.();
  });
});
