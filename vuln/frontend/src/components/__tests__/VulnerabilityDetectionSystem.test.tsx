/// <reference types="vitest" />
import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { VulnerabilityDetectionSystem } from '../VulnerabilityDetectionSystem';
import { ToastProvider } from '../ui/Toast';

describe('VulnerabilityDetectionSystem', () => {
  test('analyze button is disabled when endpoint is empty', async () => {
    render(
      <ToastProvider>
        <VulnerabilityDetectionSystem />
      </ToastProvider>
    );

    const analyzeBtn = screen.getByRole('button', { name: /analyze website|analyze/i });
    expect(analyzeBtn).toBeDisabled();
  });

  test('performs port scan and subdomain enumeration and shows success toasts', async () => {
    render(
      <ToastProvider>
        <VulnerabilityDetectionSystem />
      </ToastProvider>
    );

    // Mock port-scan
    // @ts-ignore
    global.fetch = vi.fn((url: string) => {
      if (url.includes('/port-scan')) {
        return Promise.resolve({ ok: true, json: () => Promise.resolve({ open_count: 1, open_ports: [{ port: 22, service: 'ssh' }] }) });
      }
      if (url.includes('/enumerate-subdomains')) {
        return Promise.resolve({ ok: true, json: () => Promise.resolve({ domain: 'example.com', subdomains: ['api.example.com'], total_found: 1 }) });
      }
      if (url.includes('/scan')) {
        return Promise.resolve({ ok: true, json: () => Promise.resolve({ vulnerabilities: [], scan_mode: 'passive' }) });
      }
      return Promise.resolve({ ok: true, json: () => Promise.resolve({}) });
    });

    // Port scan
    const hostInput = screen.getByPlaceholderText(/example.com or 192.168.1.1/i);
    fireEvent.change(hostInput, { target: { value: '192.168.1.1' } });
    const portBtn = screen.getByRole('button', { name: /scan ports/i });
    fireEvent.click(portBtn);

    await waitFor(() => expect(screen.getByText(/port scan completed/i)).toBeInTheDocument());

    // Subdomain enumeration
    const baseInput = screen.getByPlaceholderText(/example.com$/i);
    fireEvent.change(baseInput, { target: { value: 'example.com' } });
    const subBtn = screen.getByRole('button', { name: /find subdomains/i });
    fireEvent.click(subBtn);

    await waitFor(() => expect(screen.getByText(/subdomain enumeration completed/i)).toBeInTheDocument());

    // Clean up
    // @ts-ignore
    global.fetch.mockClear?.();
  });
});
