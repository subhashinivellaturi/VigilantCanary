import React, { useState, useRef, useEffect, lazy, Suspense } from "react";
import { motion } from "framer-motion";
import { Search, AlertCircle, CheckCircle, Loader2, Shield, Globe, AlertTriangle } from "lucide-react";
import "./VulnerabilityScanner.css";
import { useToast } from './ui/Toast';
const FindingsDisplay = lazy(() =>
  import("./FindingsDisplay").then((m) => ({ default: m.FindingsDisplay }))
);

import { API_URL } from "../api/client";

interface ProductionScanResponse {
  url: string;
  scan_timestamp: string;
  vulnerabilities_found: number;
  vulnerabilities: Array<{
    id: string;
    timestamp: string;
    vulnerability_name: string;
    severity: string;
    affected_url: string;
    scan_type: string;
    cvss_score: number;
    description: string;
    confidence: number;
  }>;
  status: string;
  scan_id: number;
  executive_summary: {
    risk_score_0_to_100: number;
    total_findings: number;
    critical_count: number;
    high_count: number;
    medium_count: number;
    low_count: number;
    executive_summary_text: string;
    overall_risk_status: string;
    scan_mode: string;
  };
  disclaimer: string;
  scan_mode: string;
}

export function VulnerabilityScanner() {
  const [endpoint, setEndpoint] = useState("");
  const [payload, setPayload] = useState("");
  const [loading, setLoading] = useState(false);
  const [productionResponse, setProductionResponse] = useState<ProductionScanResponse | null>(null);
  const resultsRef = useRef<HTMLDivElement>(null);
  const { showToast } = useToast();

  // Auto-scroll to results when scan completes
  useEffect(() => {
    if (productionResponse && resultsRef.current) {
      setTimeout(() => {
        resultsRef.current?.scrollIntoView({ behavior: "smooth", block: "start" });
      }, 500);
    }
  }, [productionResponse]);

  const handleScan = async () => {
    if (!endpoint.trim()) {
      showToast('Please enter an endpoint URL', 'error');
      return;
    }

    setLoading(true);
    setProductionResponse(null);

    try {
      const response = await fetch(`${API_URL}/scan`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          url: endpoint,
        }),
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.statusText}`);
      }

      const data: ProductionScanResponse = await response.json();
      setProductionResponse(data);
      setPayload("");
      showToast(`Scan completed for ${endpoint}`, 'success');
      window.dispatchEvent(new Event('scanCompleted'));
    } catch (err) {
      const msg = err instanceof Error ? err.message : "Scan failed";
      showToast(msg, 'error');
      setProductionResponse(null);
    } finally {
      setLoading(false);
    }
  };

  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !loading) {
      handleScan();
    }
  };

  return (
    <div className="vuln-scanner-container">
      {/* Header */}
      <div className="vuln-header">
        <h1 className="vuln-header__title">Vulnerability Scanner</h1>
        <p className="vuln-header__subtitle">Comprehensive web vulnerability scanning with AI-powered detection</p>
      </div>

      {/* Scan Form */}
      <div className="vuln-form">
        {/* Input Fields */}
        <div className="vuln-form__inputs">
          {/* Target URL */}
          <div className="form-field">
            <label className="form-field__label">
              <Globe style={{ display: "inline", marginRight: "6px", width: "16px", height: "16px" }} />
              Target URL
            </label>
            <input
              type="url"
              value={endpoint}
              onChange={(e) => setEndpoint(e.target.value)}
              onKeyPress={handleKeyPress}
              placeholder="https://example.com"
              className="form-field__input"
              disabled={loading}
            />
            <p className="form-field__description">Enter the URL you want to scan for vulnerabilities</p>
          </div>

          {/* Injection Payload */}
          <div className="form-field">
            <label className="form-field__label">
              <AlertTriangle style={{ display: "inline", marginRight: "6px", width: "16px", height: "16px" }} />
              Injection Payload (Optional)
            </label>
            <textarea
              value={payload}
              onChange={(e) => setPayload(e.target.value)}
              placeholder="Custom injection payload for advanced testing..."
              className="form-field__textarea"
              disabled={loading}
            />
            <p className="form-field__description">Advanced users can provide custom payloads for specific testing scenarios</p>
          </div>

          {/* Passive Mode Checkbox */}
          <div style={{ display: "flex", alignItems: "center", gap: "12px", padding: "16px", background: "#f8f9fa", borderRadius: "8px", border: "1px solid #e9ecef" }}>
            <input
              type="checkbox"
              id="passive-mode"
              style={{ width: "20px", height: "20px", cursor: "pointer" }}
            />
            <div style={{ flex: 1 }}>
              <label htmlFor="passive-mode" style={{ fontWeight: 600, color: "#212529", cursor: "pointer", display: "block", marginBottom: "4px" }}>
                Passive scan mode
              </label>
              <p style={{ fontSize: "12px", color: "#abb5be", margin: 0 }}>No active testing - only analyzes existing traffic and responses</p>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: "6px", background: "#d4edda", padding: "4px 12px", borderRadius: "6px" }}>
              <div style={{ width: "8px", height: "8px", background: "#28a745", borderRadius: "50%" }}></div>
              <span style={{ fontSize: "12px", fontWeight: 600, color: "#155724" }}>Safe</span>
            </div>
          </div>

          {/* Form Actions */}
          <div className="form-actions">
            <button
              onClick={handleScan}
              disabled={loading || !endpoint.trim()}
              className="form-btn form-btn--primary"
            >
              {loading ? (
                <>
                  <Loader2 style={{ width: "18px", height: "18px" }} className="spinner" />
                  <span>Analyzing Website...</span>
                </>
              ) : (
                <>
                  <Search style={{ width: "18px", height: "18px" }} />
                  <span>Start Security Scan</span>
                </>
              )}
            </button>
          </div>
          <p style={{ textAlign: "center", fontSize: "13px", color: "#6c757d" }}>
            Scan typically completes in <span style={{ color: "#0066ff", fontWeight: 600 }}>30-120 seconds</span>
          </p>
        </div>

        {/* Configuration Panel */}
        <div className="vuln-form__config">
          <div className="config-section">
            <h3 className="config-section__title">Scan Configuration</h3>
            <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
              {[
                { label: "OWASP Top 10", desc: "Identifies critical web application risks" },
                { label: "SQL Injection", desc: "Detects SQL injection vulnerabilities" },
                { label: "XSS Detection", desc: "Finds cross-site scripting vulnerabilities" },
                { label: "CSRF Protection", desc: "Verifies CSRF token protection" }
              ].map((option) => (
                <div key={option.label} className="config-option">
                  <input
                    type="checkbox"
                    className="config-option__checkbox"
                    defaultChecked
                  />
                  <div className="config-option__content">
                    <div className="config-option__title">{option.label}</div>
                    <div className="config-option__description">{option.desc}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>

      {/* Results Section */}
      {productionResponse && (
        <div className="results-box">
          <h3 className="results-box__title">Scan Results</h3>
          <Suspense fallback={<div style={{ textAlign: "center", padding: "20px", color: "#6c757d" }}>Loading results...</div>}>
            <FindingsDisplay
              findings={productionResponse.vulnerabilities.map((v) => ({
                finding_id: v.id,
                vulnerability_type: v.vulnerability_name,
                severity: v.severity,
                cvss_score: v.cvss_score,
                confidence: v.confidence,
                description: v.description,
                affected_url: v.affected_url,
              }))}
              scanMode={productionResponse.scan_mode}
            />
          </Suspense>
        </div>
      )}
    </div>
  );
}